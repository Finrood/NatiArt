<div class="container mx-auto px-4 py-8">
  <h1 class="text-3xl font-semibold mb-8 text-gray-800">Checkout</h1>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
    <!-- Left Column: User Information -->
    <div>
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4">Your Information</h2>
        <ng-container *ngIf="(isLoggedIn$ | async); else guestCheckout">
          <p class="mb-4">Welcome back, {{ (currentUser$ | async)?.username }}!</p>
        </ng-container>
        <ng-template #guestCheckout>
          <p class="mb-4">Checking out as a guest? You can also <a routerLink="/login" class="text-blue-500 hover:underline">log in</a> to use your saved information.</p>
        </ng-template>

        <!-- Step indicator -->
        <div class="flex justify-center items-center space-x-4">
          <div class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center text-sm font-medium"
               [ngClass]="{'bg-primary': currentStep === 1, 'bg-primary-light': currentStep === 2 || currentStep === 3}">
            1
          </div>
          <div class="w-16 h-1 bg-primary-light" [ngClass]="{'bg-primary': currentStep === 2 || currentStep === 3}"></div>
          <div class="w-8 h-8 rounded-full bg-primary-light text-white flex items-center justify-center text-sm font-medium"
               [ngClass]="{'bg-primary': currentStep === 2, 'bg-primary-light': currentStep === 3}">
            2
          </div>
          <div class="w-16 h-1 bg-primary-light" [ngClass]="{'bg-primary': currentStep === 3}"></div>
          <div class="w-8 h-8 rounded-full bg-primary-light text-white flex items-center justify-center text-sm font-medium"
               [ngClass]="{'bg-primary': currentStep === 3}">
            3
          </div>
        </div>

        <form [formGroup]="checkoutForm" (ngSubmit)="onSubmit()" class="mt-8 space-y-6">
          <!-- Step 1: Personal information -->
          <div *ngIf="currentStep === 1" [@slideInRight] formGroupName="userInfo" class="space-y-6">
            <div>
              <label for="email" class="block text-sm font-medium text-secondary">Email address</label>
              <input id="email" formControlName="email" type="email" required
                     class="mt-1 block w-full px-3 py-2 bg-white border border-primary rounded-md shadow-input placeholder-secondary-light focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                     [ngClass]="{'border-error': getFieldError('userInfo.email')}"
                     placeholder="you@yourbest.com">
              <p *ngIf="getFieldError('userInfo.email')" class="mt-2 text-sm text-red-600">
                {{ getFieldError('userInfo.email') }}
              </p>
            </div>

            <div>
              <label for="firstname" class="block text-sm font-medium text-secondary">First Name</label>
              <input id="firstname" formControlName="firstname" type="text" required
                     class="mt-1 block w-full px-3 py-2 bg-white border border-primary rounded-md shadow-input placeholder-secondary-light focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                     [ngClass]="{'border-error': getFieldError('userInfo.firstname')}"
                     placeholder="John">
              <p *ngIf="getFieldError('userInfo.firstname')" class="mt-2 text-sm text-red-600">
                {{ getFieldError('userInfo.firstname') }}
              </p>
            </div>

            <div>
              <label for="lastname" class="block text-sm font-medium text-secondary">Last Name</label>
              <input id="lastname" formControlName="lastname" type="text" required
                     class="mt-1 block w-full px-3 py-2 bg-white border border-primary rounded-md shadow-input placeholder-secondary-light focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                     [ngClass]="{'border-error': getFieldError('userInfo.lastname')}"
                     placeholder="Doe">
              <p *ngIf="getFieldError('userInfo.lastname')" class="mt-2 text-sm text-red-600">
                {{ getFieldError('userInfo.lastname') }}
              </p>
            </div>

            <div>
              <label for="phone" class="block text-sm font-medium text-secondary">Phone</label>
              <input id="phone" formControlName="phone" type="tel"
                     class="mt-1 block w-full px-3 py-2 bg-white border border-primary rounded-md shadow-input placeholder-secondary-light focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                     [ngClass]="{'border-error': getFieldError('userInfo.phone')}"
                     placeholder="(XX) XXXXX-XXXX">
              <p *ngIf="getFieldError('userInfo.phone')" class="mt-2 text-sm text-red-600">
                {{ getFieldError('userInfo.phone') }}
              </p>
            </div>

          </div>

          <!-- Step 2: Shipping and Billing information -->
          <div *ngIf="currentStep === 2" [@slideInRight] class="space-y-6" formGroupName="shippingInfo">
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
              <div>
                <label for="zipCode" class="block text-sm font-medium text-secondary">Zip Code</label>
                <input id="zipCode" formControlName="zipCode" type="text" required
                       class="mt-1 block w-full px-3 py-2 bg-white border border-primary rounded-md shadow-input placeholder-secondary-light focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                       [ngClass]="{'border-error': getFieldError('shippingInfo.zipCode')}"
                       placeholder="XXXXX-XXX"
                       cepFormat
                       (input)="onZipCodeChange('shippingInfo')">
                <p *ngIf="getFieldError('shippingInfo.zipCode')" class="mt-2 text-sm text-red-600">
                  {{ getFieldError('shippingInfo.zipCode') }}
                </p>
              </div>
            </div>

            <div *ngIf="isLoadingShippingAddress" class="text-center">
              <app-loading-spinner></app-loading-spinner>
              <p class="mt-2 text-sm text-secondary-light">Loading address...</p>
            </div>

            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
              <div>
                <label for="country" class="block text-sm font-medium text-secondary">Country</label>
                <input readonly id="country" formControlName="country" type="text"
                       class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-primary rounded-md shadow-input text-secondary-light focus:outline-none sm:text-sm"
                       placeholder="Country">
              </div>

              <div>
                <label for="state" class="block text-sm font-medium text-secondary">State</label>
                <input id="state" formControlName="state" type="text" required
                       class="mt-1 block w-full px-3 py-2 bg-white border border-primary rounded-md shadow-input placeholder-secondary-light focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                       [ngClass]="{'border-error': getFieldError('shippingInfo.state')}"
                       placeholder="State">
                <p *ngIf="getFieldError('shippingInfo.state')" class="mt-2 text-sm text-red-600">
                  {{ getFieldError('shippingInfo.state') }}
                </p>
              </div>

              <div>
                <label for="city" class="block text-sm font-medium text-secondary">City</label>
                <input id="city" formControlName="city" type="text" required
                       class="mt-1 block w-full px-3 py-2 bg-white border border-primary rounded-md shadow-input placeholder-secondary-light focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                       [ngClass]="{'border-error': getFieldError('shippingInfo.city')}"
                       placeholder="City">
                <p *ngIf="getFieldError('shippingInfo.city')" class="mt-2 text-sm text-red-600">
                  {{ getFieldError('shippingInfo.city') }}
                </p>
              </div>

              <div>
                <label for="neighborhood" class="block text-sm font-medium text-secondary">Neighborhood</label>
                <input id="neighborhood" formControlName="neighborhood" type="text" required
                       class="mt-1 block w-full px-3 py-2 bg-white border border-primary rounded-md shadow-input placeholder-secondary-light focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                       [ngClass]="{'border-error': getFieldError('shippingInfo.neighborhood')}"
                       placeholder="neighborhood">
                <p *ngIf="getFieldError('shippingInfo.neighborhood')" class="mt-2 text-sm text-red-600">
                  {{ getFieldError('shippingInfo.neighborhood') }}
                </p>
              </div>

              <div>
                <label for="street" class="block text-sm font-medium text-secondary">Street</label>
                <input id="street" formControlName="street" type="text" required
                       class="mt-1 block w-full px-3 py-2 bg-white border border-primary rounded-md shadow-input placeholder-secondary-light focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                       [ngClass]="{'border-error': getFieldError('shippingInfo.street')}"
                       placeholder="123 Main St">
                <p *ngIf="getFieldError('shippingInfo.street')" class="mt-2 text-sm text-red-600">
                  {{ getFieldError('shippingInfo.street') }}
                </p>
              </div>
            </div>

            <div>
              <label for="complement" class="block text-sm font-medium text-secondary">Address Complement</label>
              <input id="complement" formControlName="complement" type="text"
                     class="mt-1 block w-full px-3 py-2 bg-white border border-primary rounded-md shadow-input placeholder-secondary-light focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                     placeholder="Apartment, suite, unit, building, floor, etc.">
            </div>

            <div class="flex items-center space-x-2">
              <input type="checkbox" class="form-checkbox h-5 w-5 text-primary"
                     [checked]="sameShippingAsBilling"
                     (change)="toggleSameShippingAsBilling($event)">
              <label class="text-sm font-medium text-secondary">Same as shipping address</label>
            </div>

            <div *ngIf="!sameShippingAsBilling" [@slideInRight] formGroupName="billingInfo" class="space-y-6">
              <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div>
                  <label for="billingzipCode" class="block text-sm font-medium text-secondary">Zip Code</label>
                  <input id="billingzipCode" formControlName="zipCode" type="text" required
                         class="mt-1 block w-full px-3 py-2 bg-white border border-primary rounded-md shadow-input placeholder-secondary-light focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                         [ngClass]="{'border-error': getFieldError('billingInfo.zipCode')}"
                         placeholder="XXXXX-XXX"
                         cepFormat
                         (input)="onZipCodeChange('billingInfo')">
                  <p *ngIf="getFieldError('billingInfo.zipCode')" class="mt-2 text-sm text-red-600">
                    {{ getFieldError('billingInfo.zipCode') }}
                  </p>
                </div>
              </div>

              <div *ngIf="isLoadingBillingAddress" class="text-center">
                <app-loading-spinner></app-loading-spinner>
                <p class="mt-2 text-sm text-secondary-light">Loading address...</p>
              </div>

              <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div>
                  <label for="billingcountry" class="block text-sm font-medium text-secondary">Country</label>
                  <input readonly id="billingcountry" formControlName="country" type="text"
                         class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-primary rounded-md shadow-input text-secondary-light focus:outline-none sm:text-sm"
                         placeholder="Country">
                </div>

                <div>
                  <label for="billingstate" class="block text-sm font-medium text-secondary">State</label>
                  <input id="billingstate" formControlName="state" type="text" required
                         class="mt-1 block w-full px-3 py-2 bg-white border border-primary rounded-md shadow-input placeholder-secondary-light focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                         [ngClass]="{'border-error': getFieldError('billingInfo.state')}"
                         placeholder="State">
                  <p *ngIf="getFieldError('billingInfo.state')" class="mt-2 text-sm text-red-600">
                    {{ getFieldError('billingInfo.state') }}
                  </p>
                </div>

                <div>
                  <label for="billingcity" class="block text-sm font-medium text-secondary">City</label>
                  <input id="billingcity" formControlName="city" type="text" required
                         class="mt-1 block w-full px-3 py-2 bg-white border border-primary rounded-md shadow-input placeholder-secondary-light focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                         [ngClass]="{'border-error': getFieldError('billingInfo.city')}"
                         placeholder="City">
                  <p *ngIf="getFieldError('billingInfo.city')" class="mt-2 text-sm text-red-600">
                    {{ getFieldError('billingInfo.city') }}
                  </p>
                </div>

                <div>
                  <label for="billingneighborhood" class="block text-sm font-medium text-secondary">Neighborhood</label>
                  <input id="billingneighborhood" formControlName="neighborhood" type="text" required
                         class="mt-1 block w-full px-3 py-2 bg-white border border-primary rounded-md shadow-input placeholder-secondary-light focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                         [ngClass]="{'border-error': getFieldError('billingInfo.neighborhood')}"
                         placeholder="neighborhood">
                  <p *ngIf="getFieldError('billingInfo.neighborhood')" class="mt-2 text-sm text-red-600">
                    {{ getFieldError('billingInfo.neighborhood') }}
                  </p>
                </div>

                <div>
                  <label for="billingstreet" class="block text-sm font-medium text-secondary">Street</label>
                  <input id="billingstreet" formControlName="street" type="text" required
                         class="mt-1 block w-full px-3 py-2 bg-white border border-primary rounded-md shadow-input placeholder-secondary-light focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                         [ngClass]="{'border-error': getFieldError('billingInfo.street')}"
                         placeholder="123 Main St">
                  <p *ngIf="getFieldError('billingInfo.street')" class="mt-2 text-sm text-red-600">
                    {{ getFieldError('billingInfo.street') }}
                  </p>
                </div>
              </div>

              <div>
                <label for="billingcomplement" class="block text-sm font-medium text-secondary">Address Complement</label>
                <input id="billingcomplement" formControlName="complement" type="text"
                       class="mt-1 block w-full px-3 py-2 bg-white border border-primary rounded-md shadow-input placeholder-secondary-light focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                       placeholder="Apartment, suite, unit, building, floor, etc.">
              </div>
            </div>
          </div>

          <!-- Step 3: Payment Information -->
          <div *ngIf="currentStep === 3" [@slideInRight] formGroupName="paymentInfo" class="space-y-6">
            <div>
              <label for="paymentMethod" class="block text-sm font-medium text-secondary">Payment Method</label>
              <select id="paymentMethod" formControlName="paymentMethod" class="mt-1 block w-full px-3 py-2 bg-white border border-primary rounded-md shadow-input placeholder-secondary-light focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                <option value="">Select payment method</option>
                <option value="credit_card">Credit Card</option>
                <option value="debit_card">Debit Card</option>
                <option value="pix">PIX</option>
              </select>
            </div>

            <ng-container *ngIf="checkoutForm.get('paymentInfo.paymentMethod')?.value === 'credit_card' || checkoutForm.get('paymentInfo.paymentMethod')?.value === 'debit_card'">
              <div>
                <label for="cardNumber" class="block text-sm font-medium text-secondary">Card Number</label>
                <input id="cardNumber" formControlName="cardNumber" type="text" required
                       class="mt-1 block w-full px-3 py-2 bg-white border border-primary rounded-md shadow-input placeholder-secondary-light focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                       [ngClass]="{'border-error': getFieldError('paymentInfo.cardNumber')}"
                       placeholder="XXXX XXXX XXXX XXXX">
                <p *ngIf="getFieldError('paymentInfo.cardNumber')" class="mt-2 text-sm text-red-600">
                  {{ getFieldError('paymentInfo.cardNumber') }}
                </p>
              </div>

              <div class="grid grid-cols-2 gap-6">
                <div>
                  <label for="expirationDate" class="block text-sm font-medium text-secondary">Expiration Date</label>
                  <input id="expirationDate" formControlName="expirationDate" type="text" required
                         class="mt-1 block w-full px-3 py-2 bg-white border border-primary rounded-md shadow-input placeholder-secondary-light focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                         [ngClass]="{'border-error': getFieldError('paymentInfo.expirationDate')}"
                         placeholder="MM/YY">
                  <p *ngIf="getFieldError('paymentInfo.expirationDate')" class="mt-2 text-sm text-red-600">
                    {{ getFieldError('paymentInfo.expirationDate') }}
                  </p>
                </div>

                <div>
                  <label for="cvv" class="block text-sm font-medium text-secondary">CVV</label>
                  <input id="cvv" formControlName="cvv" type="text" required
                         class="mt-1 block w-full px-3 py-2 bg-white border border-primary rounded-md shadow-input placeholder-secondary-light focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                         [ngClass]="{'border-error': getFieldError('paymentInfo.cvv')}"
                         placeholder="123">
                  <p *ngIf="getFieldError('paymentInfo.cvv')" class="mt-2 text-sm text-red-600">
                    {{ getFieldError('paymentInfo.cvv') }}
                  </p>
                </div>
              </div>
            </ng-container>

            <ng-container *ngIf="checkoutForm.get('paymentInfo.paymentMethod')?.value === 'pix'">
              <div>
                <label for="pixKey" class="block text-sm font-medium text-secondary">PIX Key</label>
                <input id="pixKey" formControlName="pixKey" type="text" required
                       class="mt-1 block w-full px-3 py-2 bg-white border border-primary rounded-md shadow-input placeholder-secondary-light focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                       [ngClass]="{'border-error': getFieldError('paymentInfo.pixKey')}"
                       placeholder="Enter your PIX key">
                <p *ngIf="getFieldError('paymentInfo.pixKey')" class="mt-2 text-sm text-red-600">
                  {{ getFieldError('paymentInfo.pixKey') }}
                </p>
              </div>
            </ng-container>

            <div class="flex justify-between mt-6">
              <button type="button" (click)="onPreviousStep()"
                      [disabled]="currentStep === 3"
                      class="flex justify-center py-2 px-4 border border-primary rounded-md shadow-input text-sm font-medium text-primary hover:bg-primary-light focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                Previous
              </button>
              <button type="submit" [disabled]="!isCurrentStepValid()"
                      class="flex justify-center py-2 px-4 border border-transparent rounded-md shadow-input text-sm font-medium text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                Place Order
              </button>
            </div>
          </div>

          <div class="flex justify-between mt-6">
            <button type="button" (click)="onPreviousStep()"
                    [disabled]="currentStep === 1"
                    class="flex justify-center py-2 px-4 border border-primary rounded-md shadow-input text-sm font-medium text-primary hover:bg-primary-light focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
              Previous
            </button>
            <button type="button" (click)="onNextStep()"
                    [disabled]="!isCurrentStepValid()"
                    class="flex justify-center py-2 px-4 border border-transparent rounded-md shadow-input text-sm font-medium text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
              Next
            </button>
          </div>
      </form>
    </div>

    <!-- Right Column: Order Summary -->
    <div>
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4">Order Summary</h2>
        <div class="space-y-4">
          <ng-container *ngFor="let item of cartItems$ | async">
            <div class="flex justify-between items-center">
              <div>
                <p class="font-medium">{{ item.product.label }}</p>
                <p class="text-sm text-gray-600">Quantity: {{ item.quantity }}</p>
              </div>
              <p class="font-medium">{{ item.product.markedPrice * item.quantity | currency:'BRL' }}</p>
            </div>
          </ng-container>
        </div>
        <div class="border-t mt-4 pt-4">
          <div class="flex justify-between items-center font-semibold">
            <p>Total</p>
            <p>{{ cartTotal$ | async | currency:'BRL' }}</p>
          </div>
        </div>
      </div>

      <button
        (click)="onSubmit()"
        [disabled]="checkoutForm.invalid || (isLoading$ | async)"
        class="w-full bg-blue-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50"
      >
        <ng-container *ngIf="!(isLoading$ | async); else processingOrder">
          Place Order
        </ng-container>
        <ng-template #processingOrder>
          Processing...
        </ng-template>
      </button>
    </div>
  </div>
</div>
